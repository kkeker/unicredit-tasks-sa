# Решение задачи #3

## Концептуальная архитектура решения

### Диаграмма КАР
![КАР Задачи 3](assets/kar.png "Концептуальная архитектура решения задачи 3")

### Таблица связей

| № | Описание |
| -- | -- |
| 1 | Использование сторонней ИС МВД для получения выгрузки черного списка паспортов по расписанию. |
| 2 | Выгрузка черных списков паспортов после обработки и дедубликации в Платформу данных в слой хранения в соответствии с Единой моделью данных. |
| 3 | Публикация события обновления черных списков паспортов в соответствии с зарегистрированной схемой бизнес-событий. |
| 4 | Получение события обновления черных списков системой учета Физических лиц в соответствии с подпиской на бизнес-события. |
| 5 | Получение обработанных черных списков паспортов из Платформы данных через Витрины данных. |
| 6 | Выгрузка изменений в карточках физических лиц в Платформу данных в соответствии с объектной моделью изменений Единой модели данных после сопоставления имеющейся базы ФЛ с черным списком паспортов. |
| 7 | Публикация события обновления карточек физических лиц банка в соответствии с зарегистрированной схемой бизнес-событий. |
| 8 | Получение события обновления черных списков системой учета связей Юридических лиц в соответствии с подпиской на бизнес-события. |
| 9 | Получение обработанных черных списков паспартов из Платформы данных через Витрины данных. |
| 10 | Публикация события обновления в связях Юридических лиц в дереве участников ЮЛ после проверки по черным спискам паспортов. |
| 11 | Получение события обновления структуры связей Юридических лиц в соответствии с подпиской на бизнес-события. |
| 12 | Получение плоской структуры изменений в профилях Юридических лиц, которые следует обновить в учетной системе Юридических лиц. |
| 13 | Выгрузка изменений в карточках юридических лиц в Платформу данных в соответствии с объектной моделью изменений Единой модели данных после сопоставления имеющейся базы ЮЛ с черным списком паспортов через систему связей ЮЛ. |
| 14 | Публикация события обновления карточек юридических лиц банка в соответствии с зарегистрированной схемой бизнес-событий. |
| 15 | Получение системами-потребителями событий: обновление черных списков паспортов; обновление карточек ЮЛ; обновление карточек ФЛ; в соответствии с подпиской на бизнес-события. |
| 16 | Получение данных из Витрин данных: черные списки паспортов; карточки ЮЛ; карточки ФЛ. |
| 17 | Проверка списка ЮЛ по каталогу банка, в том числе на пометки KYC. |
| 18 | Проверка списка ФЛ по каталогу банка, в том числе на пометки KYC. |

## Архитектура систем

### [Общие правила](../Rules.md)

### Диаграмма АС (ИС "Система проверки паспортов по черным спискам")

![АС Проверка паспортов Задачи 3](assets/as-passportCheck.png "Архитектура системы Проверки паспортов задачи 3")

### Диаграмма АС (ИС "Связи ЮЛ")

![АС Связи ЮЛ Задачи 3](assets/as-ulGroups.png "Архитектура системы Управление связями ЮЛ задачи 3")

### Диаграмма АС (ИС "Карточка ФЛ")

![АС Карточка ФЛ Задачи 3](assets/as-flCard.png "Архитектура системы Карточка ФЛ задачи 3")

### Диаграмма АС (ИС "Карточка ЮЛ")

![АС Карточка ЮЛ Задачи 3](assets/as-ulCard.png "Архитектура системы Карточка ЮЛ задачи 3")

## Диаграмма потоков данных

Это не самый удачный вид диаграммы, если речь идет о классических DFD, потому что сложно найти поддержку нотаций этого вида диаграмм в открытых инструментах. В данном случае слишком много связей, особенно если разбивать каждую систему на Process, External Entity и Data Store. Обычно ее заменяют на BPMN, Sequence diagram или диаграмму взаимодействия систем в ArchiMate, в зависимости от необходимости отображения бизнес-процессов, последовательности или систем с подсистемами, интерфейсами и протоколами.

Я несколько раз пытался нарисовать ее вручную или через подход Diagram as a Code в надежде, что инструмент сможет расположить элементы и связи лучше, но диаграмма получилась нечитаемой. Проще читать ее код глазами прямо в [исходном файле](src/dfd.d2). Прикладывать изображение не имеет смысла, так как оно абсолютно нечитаемо.

![Data Flow Diagram](assets/dfd.svg "Data Flow Diagram")

## Architecture Decision Log

[Текст задания](../README.md)

- Для начала необходимо получить список от МВД в архиве Bzip2 через HTTPS. Существует несколько вариантов для этого, начиная от создания задания через дизайн-студию некоего ESB или DI, который может разложить данные на сообщения или сразу записать их в базу данных. Однако предположим, что паттерн ESB уходит в прошлое, и мы не используем его. Выбор ETL рассмотрен в [общих правилах](../Rules.md).
- Любое из перечисленных решений, используя реляционную базу данных рядом с импортером, сможет решить проблемы дедубликации данных и проверки их качества в импортируемом файле (например, пустые записи), чтобы в базе данных остались только данные более высокого качества. Выбор базы данных рассмотрен в [общих правилах](../Rules.md).
- После выполнения задачи импорта можно приступить к следующим задачам: оповестить другие системы, что импорт завершен, и данные обновились; заставить системы учета ФЛ и ЮЛ изменить KYC-статус для уже существующих клиентов; предоставить возможность проверки по новым спискам создаваемых клиентов, данные о которых еще не содержатся в учетных системах. Для решения этой задачи есть несколько путей, но их можно разделить на следующие кейсы:
  - Потенциальный клиент, которого ранее не было в наших системах и которого не использовал наши услуги. В зависимости от бизнес-процесса, проверка может быть синхронной или асинхронной. Если бизнес-процесс предполагает паузу для проверки документов (например, в сочетании с проверкой информационной безопасности или оценкой рисков RORAC), то можно использовать асинхронный транспорт и ожидать ответа, выполнять повторные попытки, более подробное описание можно найти в [общих правилах](../Rules.md). Если есть процесс, который требует более быстрого и мгновенного ответа, чтобы определить, будем ли мы работать с этим клиентом из-за потенциальных проблем с документами, то предпочтительнее использовать синхронный транспорт. Однако это может вызвать проблемы для batch-задач обработки данных. Для решения этой задачи можно использовать несколько интерфейсов в каждой информационной системе, чтобы они реализовывали операции над одной и той же моделью данных и объектами данных. Конкретно, предлагается системе, в зависимости от бизнес-процесса и технических возможностей, выбрать между заказом для себя быстрой кешируемой витрины данных для SQL-поиска, подробнее описанной в [общих правилах](../Rules.md). Если это не приемлемо, то также можно применить оптимизацию, кешируя эти данные из платформы данных. Это позволит получить данные более оперативно, сами данные будут триггером для действий их импорта (EDA), обеспечивая максимальную актуальность данных. Также можно использовать сообщения из Каталога бизнес-событий об изменении данных в источнике для начала их импорта из платформы данных - этот вариант предпочтителен, так как он не зависит от изменений графика импорта или новых попыток импорта в источнике. Также можно использовать тот же самый канал данных, который использует система-источник списков для отправки в платформу данных для своих нужд и наполнения своего кеша. В данном примере это Kafka-транспорт с единым форматом данных в виде потока изменений объектной модели. Этот вариант позволит получить данные более оперативно, сами данные будут триггером для действий их импорта (EDA), и вы получите максимальную актуальность данных. Однако вам придется выполнить часть работы платформы данных, включая объединение данных из потока изменений объектной модели у себя, реализацию запросов инициирующих данных в самом начале, обработку других топиков статусов и обработку топиков с отложенной обработкой (DLQ).
  - Проверка существующих клиентов компании в учетных системах также представляет несколько вариантов, и архитектура может постепенно эволюционировать, улучшая свои интеграции. Можно выполнить проверку клиента через REST-запросы в учетных системах, используя Карточку ФЛ и Карточку ЮЛ. Данные в этих информационных системах уже предрассчитаны на момент запроса и не рассчитываются на лету. Этот запрос будет обработан достаточно быстро, поскольку представляет собой поиск в индексированной базе данных подготовленных данных в этих сервисах. Сами REST-интерфейсы уже рассчитаны на batch-обработку и ожидают массив данных для проверки, состоящий из одного или более клиентов. Этот вариант подходит для быстрого ответа в синхронных процессах, где нет возможности создания кеша или заказа дата-продукта в Платформе данных. Вариант с кешированием данных у себя или использование витрины дата-продукта в Платформе данных аналогичен описанному выше для новых клиентов, которых нет в учетных информационных системах. Все информационные системы выгружают свои объектные модели в Платформу данных, поэтому процесс не отличается. Оптимизации с кешированием и триггерами обновления кеша аналогичны описанным выше.
- Почему стоит вести работу с черными списками в учетных системах профилей ЮЛ и ФЛ? - Сравнив количество данных из выгрузки паспортов и количество данных клиентов, проще передавать списки в учетные системы клиентов, чем делать это иначе. Это также более логичный шаг с точки зрения понимания систем владельцев данных и работы с MDM.
- Почему в данной архитектуре Платформа данных сама не получает данные из МВД и не хранит их? - Обычно такие системы имеют ETL и могли бы сами выполнить эту задачу, но тогда теряется антикоррупционный слой, и Платформа данных начинает выполнять функции, которые ей не следует выполнять, что увеличивает нагрузку на команды, обслуживающие эту группу систем. Интеграция с МВД, а также источниками черных списков, всегда может меняться и потребовать более сложных процессов обработки внутри себя. Тем не менее, это не входит в зону ответственности платформы хранения и контроля качества данных компании. Обычно ETL в таких системах нужен только для того, чтобы помочь системам без технических или финансовых возможностей передать свои данные в эту самую Платформу данных, например, CDC из чужой системы, подобной коробочной АБС.
- Почему система работы с ЮЛ разделена на две разные ИС? - Это вполне логичный шаг с точки зрения работы с деревом участников ФЛ, как указано в условии задачи. Такие ИС обычно предоставляют несколько вариантов создания связей. Первый вариант - это официальные открытые источники (которые остаются за пределами данного решения) и обычно содержат открытые данные от государственных систем и регуляторов. Второй вариант - это вероятностные связи, которые основываются на данных, собранных из разных источников внутри и вне компании и используют ML-алгоритмы для определения связей. Третий вариант - это ручные связи, создаваемые через пользовательский интерфейс этой ИС по разным причинам. Если ответственный эксперт из своих источников решит создать такую связь для уменьшения рисков компании (например, для пометки теневого учредительства), то он может это сделать. В то же время связи и ведение профилей ЮЛ - это разные контексты, поэтому для их учета в учетной системе существует отдельная ИС.
- Избыточно ли использование множества интерфейсов в одной ИС? - На самом деле нет, если это стало стандартной практикой в компании. Более подробно в общих правилах.
- Почему система создания связей в ФЛ использует графовую БД, и какую именно? - Поскольку участие физических лиц в юридических лицах может быть сложно связанным в стиле М2М (many-to-many), то проще использовать графовую базу данных, по которой легко выполнять графовые операции, такие как поиск по вершинам. Это представление также отлично подходит для отображения таких связей и для работы с ML-алгоритмами, которые определяют вероятностные связи. Выбор решения рассмотрен в общих правилах.
- Почему системы "Связи ФЛ" и "Карточка ФЛ" связаны через Kafka, а не так, как другие ИС связаны между собой? - Эти системы имеют прочные внутренние связи в рамках бизнес-процесса, и они также связаны напрямую, чтобы продемонстрировать различные методы интеграции. Предполагается, что сами эти системы не имеют установленный Kafka только для этой задачи, а используют общий iPaaS (интеграционную платформу как сервис) для обмена сообщениями.
Системы "Связи ЮЛ", "Карточка ФЛ" и "Карточка ЮЛ" также имеют свой пользовательский интерфейс для ручного создания и редактирования учетных объектов.
